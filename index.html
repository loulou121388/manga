<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anime Particle Gacha</title>
    <style>
        /* --- åŠ¨æ¼«æŠ½å¡é£æ ¼ UI è®¾è®¡ --- */
        @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&display=swap');

        body { margin: 0; overflow: hidden; background-color: #1a1a2e; font-family: 'Orbitron', sans-serif; }
        
        /* èƒŒæ™¯ç½‘æ ¼è£…é¥° */
        .bg-grid {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-image: 
                linear-gradient(rgba(0, 255, 255, 0.1) 1px, transparent 1px),
                linear-gradient(90deg, rgba(0, 255, 255, 0.1) 1px, transparent 1px);
            background-size: 50px 50px;
            pointer-events: none; z-index: -1;
        }

        /* åŠ è½½å±‚ */
        #loader {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #000; color: #ff00de; z-index: 999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: opacity 0.5s;
        }
        .loading-bar { width: 200px; height: 4px; background: #333; margin-top: 10px; border-radius: 2px; }
        .loading-progress { width: 0%; height: 100%; background: #00f3ff; transition: width 0.3s; box-shadow: 0 0 10px #00f3ff; }

        /* åº•éƒ¨æŠ½å¡æ  */
        #gacha-bar {
            position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);
            display: flex; gap: 15px; padding: 15px;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
            z-index: 10;
            overflow-x: auto;
            max-width: 90vw;
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            width: 80px; height: 80px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid transparent;
            cursor: pointer;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
            overflow: hidden;
        }
        .card:hover { transform: translateY(-5px) scale(1.05); background: rgba(255, 255, 255, 0.2); }
        .card.active {
            border-color: #ff00de;
            box-shadow: 0 0 15px #ff00de, inset 0 0 10px #ff00de;
            background: rgba(255, 0, 222, 0.1);
        }
        
        /* å¡ç‰‡å†…çš„æ–‡å­—/å›¾æ ‡ */
        .card-icon { font-size: 24px; margin-bottom: 5px; }
        .card-name { font-size: 10px; color: #fff; text-align: center; font-weight: bold; text-shadow: 0 2px 4px black; }

        /* å…¨å±æŒ‰é’® */
        #fs-btn {
            position: absolute; top: 20px; right: 20px;
            background: rgba(0, 243, 255, 0.1); border: 1px solid #00f3ff;
            color: #00f3ff; padding: 8px 15px; border-radius: 5px;
            cursor: pointer; font-family: 'Orbitron', sans-serif;
            transition: 0.3s; z-index: 20;
        }
        #fs-btn:hover { background: #00f3ff; color: #000; box-shadow: 0 0 15px #00f3ff; }

        /* è°ƒè¯•/æç¤ºä¿¡æ¯ */
        #status-info {
            position: absolute; top: 20px; left: 20px;
            color: rgba(255,255,255,0.7); font-size: 12px;
            pointer-events: none;
        }
        video { display: none; }
    </style>

    <!-- å¼•å…¥åº“ -->
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
</head>
<body>

    <div class="bg-grid"></div>

    <div id="loader">
        <div style="font-size: 24px; font-weight: bold;">SYSTEM INITIALIZING</div>
        <div class="loading-bar"><div class="loading-progress" id="progress"></div></div>
        <div style="margin-top: 10px; font-size: 12px; color: #666;">Waiting for Camera & GPU...</div>
    </div>

    <div id="status-info">
        <div>ç³»ç»ŸçŠ¶æ€: <span id="sys-status" style="color:#0f0">å¾…æœº</span></div>
        <div>æ‰‹åŠ¿æ§åˆ¶: <span id="hand-status">æœªæ£€æµ‹</span></div>
    </div>

    <button id="fs-btn">â›¶ FULLSCREEN</button>

    <!-- æŠ½å¡ UI é¢æ¿ -->
    <div id="gacha-bar">
        <!-- å¡ç‰‡å†…å®¹ç”± JS åŠ¨æ€ç”Ÿæˆ -->
    </div>

    <video id="input-video" playsinline></video>

    <script type="module">
        import * as THREE from 'three';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';
        import { EffectComposer } from 'three/addons/postprocessing/EffectComposer.js';
        import { RenderPass } from 'three/addons/postprocessing/RenderPass.js';
        import { UnrealBloomPass } from 'three/addons/postprocessing/UnrealBloomPass.js';

        // ================= é…ç½®åŒºåŸŸ =================
        // âš ï¸ é‡ç‚¹ï¼šå°†ä¸‹é¢çš„ 'text' æ¢æˆä½ çš„å›¾ç‰‡è·¯å¾„ (ä¾‹å¦‚ './images/doraemon.png')
        // å¦‚æœå›¾ç‰‡è·¯å¾„æ— æ•ˆï¼Œç³»ç»Ÿä¼šè‡ªåŠ¨å›é€€åˆ°ç”Ÿæˆæ–‡å­—ç²’å­
        const CHARACTERS = [
            { name: 'å“†å•¦Aæ¢¦',  key: 'doraemon', color: '#00a0e9', icon: 'ğŸ±', src= 'images/doraemon.png' },
            { name: 'èœ¡ç¬”å°æ–°', key: 'shinchan', color: '#ff4444', icon: 'ğŸ–ï¸', src= 'images/shinchan.png' },
            { name: 'æŸ¯å—',     key: 'conan',    color: '#3366cc', icon: 'ğŸ”', src= 'images/conan.png' },
            { name: 'åº“æ´›ç±³',   key: 'kuromi',   color: '#a020f0', icon: 'ğŸ’€', src= 'images/kuromi.png' },
            { name: 'Hello Kitty', key: 'kitty', color: '#ff69b4', icon: 'ğŸ€', src= 'images/kitty.png' },
            { name: 'Chiikawa', key: 'chiikawa', color: '#ffffff', icon: 'ğŸ¹', src= 'images/chiikawa.png' }
        ];

        let scene, camera, renderer, composer, particles;
        let originalPositions = []; // è®°å½•åƒç´ çš„åŸå§‹ä½ç½® (x, y, 0)
        let colors = [];            // è®°å½•åŸå§‹é¢œè‰²
        let currentPositions = [];  // å½“å‰åŠ¨ç”»ä½ç½®
        let handDispersion = 0;     // æ‰‹åŠ¿æ§åˆ¶å˜é‡ (0=èšæ‹¢, 1=ç‚¸å¼€)
        
        // ================= åˆå§‹åŒ– UI =================
        function initUI() {
            const container = document.getElementById('gacha-bar');
            CHARACTERS.forEach((char, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                if(index === 0) card.classList.add('active'); // é»˜è®¤é€‰ä¸­ç¬¬ä¸€ä¸ª
                
                card.innerHTML = `
                    <div class="card-icon">${char.icon}</div>
                    <div class="card-name">${char.name}</div>
                `;
                
                card.onclick = () => {
                    // åˆ‡æ¢æ¿€æ´»çŠ¶æ€æ ·å¼
                    document.querySelectorAll('.card').forEach(c => c.classList.remove('active'));
                    card.classList.add('active');
                    // åŠ è½½æ–°æ¨¡å‹
                    loadCharacter(char);
                };
                container.appendChild(card);
            });

            document.getElementById('fs-btn').onclick = () => {
                if (!document.fullscreenElement) document.documentElement.requestFullscreen();
                else document.exitFullscreen();
            };
        }

        // ================= æ ¸å¿ƒï¼šå›¾ç‰‡/æ–‡å­—è½¬ç²’å­ =================
        function loadCharacter(charData) {
            // 1. å°è¯•åŠ è½½å›¾ç‰‡
            const img = new Image();
            img.crossOrigin = "Anonymous"; // å…è®¸è·¨åŸŸ
            img.src = charData.src;

            img.onload = () => {
                createParticlesFromImage(img, 1.0);
            };

            img.onerror = () => {
                console.warn(`å›¾ç‰‡ ${charData.src} åŠ è½½å¤±è´¥ï¼Œåˆ‡æ¢ä¸ºæ–‡å­—ç”Ÿæˆæ¨¡å¼`);
                createParticlesFromText(charData.name, charData.color);
            };
        }

        // å¤‡é€‰æ–¹æ¡ˆï¼šå¦‚æœæ²¡æœ‰å›¾ç‰‡ï¼Œç”¨ Canvas ç”»æ–‡å­—ç”Ÿæˆç²’å­
        function createParticlesFromText(text, colorStr) {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 400; canvas.height = 400;
            
            // ç”»æ–‡å­—
            ctx.fillStyle = colorStr;
            ctx.font = 'bold 80px Arial';
            ctx.textAlign = 'center';
            ctx.textBaseline = 'middle';
            ctx.fillText(text, 200, 200);

            // å¢åŠ ä¸€äº›è£…é¥°åœ†åœˆ
            ctx.strokeStyle = colorStr;
            ctx.lineWidth = 5;
            ctx.beginPath(); ctx.arc(200, 200, 140, 0, Math.PI*2); ctx.stroke();

            createParticlesFromImage(canvas, 0.5); // 0.5 æ˜¯ç¼©æ”¾ç³»æ•°
        }

        // ä» Image æˆ– Canvas æå–åƒç´ æ•°æ®ç”Ÿæˆç²’å­
        function createParticlesFromImage(imageSource, scaleFactor = 1.0) {
            // åˆ›å»ºä¸´æ—¶çš„ canvas æ¥è¯»å–åƒç´ 
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            // é™åˆ¶æœ€å¤§å°ºå¯¸ä»¥ä¿è¯æ€§èƒ½
            const maxSize = 200; 
            let w = imageSource.width;
            let h = imageSource.height;
            
            // ä¿æŒçºµæ¨ªæ¯”ç¼©æ”¾
            if (w > h) { h = Math.round((h * maxSize) / w); w = maxSize; } 
            else { w = Math.round((w * maxSize) / h); h = maxSize; }
            
            canvas.width = w; canvas.height = h;
            // å‚ç›´ç¿»è½¬å›¾ç‰‡ï¼Œå› ä¸º WebGL Yè½´æ˜¯å‘ä¸Šçš„
            ctx.translate(0, h); ctx.scale(1, -1);
            ctx.drawImage(imageSource, 0, 0, w, h);

            const imgData = ctx.getImageData(0, 0, w, h).data;
            
            // æ¸…ç©ºæ—§æ•°æ®
            originalPositions = [];
            currentPositions = [];
            colors = [];

            // éå†åƒç´ 
            const threshold = 10; // Alpha é˜ˆå€¼ï¼Œè¿‡æ»¤å®Œå…¨é€æ˜çš„åƒç´ 
            for (let y = 0; y < h; y++) {
                for (let x = 0; x < w; x++) {
                    const i = (y * w + x) * 4;
                    const r = imgData[i] / 255;
                    const g = imgData[i + 1] / 255;
                    const b = imgData[i + 2] / 255;
                    const a = imgData[i + 3];

                    if (a > threshold) {
                        // å±…ä¸­åæ ‡
                        const px = (x - w / 2) * 0.15;
                        const py = (y - h / 2) * 0.15;
                        const pz = 0;

                        originalPositions.push(px, py, pz);
                        // åˆå§‹éšæœºæ•£å¼€çš„ä½ç½®
                        currentPositions.push(
                            (Math.random() - 0.5) * 50,
                            (Math.random() - 0.5) * 50,
                            (Math.random() - 0.5) * 50
                        );
                        colors.push(r, g, b);
                    }
                }
            }

            updateGeometry();
        }

        function updateGeometry() {
            if (particles) scene.remove(particles);

            const geometry = new THREE.BufferGeometry();
            geometry.setAttribute('position', new THREE.Float32BufferAttribute(currentPositions, 3));
            geometry.setAttribute('color', new THREE.Float32BufferAttribute(colors, 3));

            const material = new THREE.PointsMaterial({
                size: 0.15,
                vertexColors: true, // å…³é”®ï¼šå¼€å¯é¡¶ç‚¹é¢œè‰²ï¼Œä¿ç•™å¡é€šåŸè‰²
                transparent: true,
                opacity: 0.9,
                depthWrite: false,
                blending: THREE.AdditiveBlending
            });

            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        // ================= Three.js åœºæ™¯è®¾ç½® =================
        function initThree() {
            scene = new THREE.Scene();
            // æ·±è“ç´«è‰²èƒŒæ™¯é›¾æ°”
            scene.fog = new THREE.FogExp2(0x1a1a2e, 0.02);

            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            camera.position.z = 25;

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            renderer.setPixelRatio(window.devicePixelRatio);
            document.body.appendChild(renderer.domElement);

            const controls = new OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 0.5;

            // è¾‰å…‰åæœŸå¤„ç† (å¢åŠ åŠ¨æ¼«ç§‘æŠ€æ„Ÿ)
            const renderScene = new RenderPass(scene, camera);
            const bloomPass = new UnrealBloomPass(new THREE.Vector2(window.innerWidth, window.innerHeight), 1.5, 0.4, 0.85);
            bloomPass.strength = 1.0;
            bloomPass.radius = 0.5;
            bloomPass.threshold = 0.1;

            composer = new EffectComposer(renderer);
            composer.addPass(renderScene);
            composer.addPass(bloomPass);

            // åˆå§‹åŠ è½½ç¬¬ä¸€ä¸ªè§’è‰²
            loadCharacter(CHARACTERS[0]);

            window.addEventListener('resize', () => {
                camera.aspect = window.innerWidth / window.innerHeight;
                camera.updateProjectionMatrix();
                renderer.setSize(window.innerWidth, window.innerHeight);
                composer.setSize(window.innerWidth, window.innerHeight);
            });
        }

        // ================= åŠ¨ç”»å¾ªç¯ =================
        function animate() {
            requestAnimationFrame(animate);

            if (particles && originalPositions.length > 0) {
                const positions = particles.geometry.attributes.position.array;
                const count = originalPositions.length / 3;
                const time = Date.now() * 0.001;

                // åŠ¨ç”»é€»è¾‘ï¼šæ’å€¼ç§»åŠ¨
                // æ‰‹åŠ¿ dispersion: 0 (èšæ‹¢) -> 1 (ç‚¸å¼€)
                
                for (let i = 0; i < count; i++) {
                    const ix = i * 3;
                    const iy = i * 3 + 1;
                    const iz = i * 3 + 2;

                    // åŸå§‹ç›®æ ‡ä½ç½®
                    let tx = originalPositions[ix];
                    let ty = originalPositions[iy];
                    let tz = originalPositions[iz];

                    // åŠ ä¸Šæ‰‹åŠ¿æ‰©æ•£æ•ˆæœ
                    if (handDispersion > 0.05) {
                        const explosionForce = handDispersion * 20; // çˆ†ç‚¸èŒƒå›´
                        // åŸºäºå™ªç‚¹çš„éšæœºåç§»
                        tx += (Math.random() - 0.5) * explosionForce;
                        ty += (Math.random() - 0.5) * explosionForce;
                        tz += (Math.random() - 0.5) * explosionForce;
                    } 
                    
                    // æ‚¬æµ®å‘¼å¸æ•ˆæœ (åŠ¨æ¼«äººç‰©åœ¨å‘¼å¸)
                    if (handDispersion < 0.1) {
                         tx += Math.sin(time * 2 + ty * 0.5) * 0.2;
                         ty += Math.cos(time * 1.5 + tx * 0.5) * 0.2;
                    }

                    // ç§»åŠ¨ç²’å­
                    const speed = 0.1 + handDispersion * 0.1; // ç‚¸å¼€æ—¶ç§»åŠ¨æ›´å¿«
                    positions[ix] += (tx - positions[ix]) * speed;
                    positions[iy] += (ty - positions[iy]) * speed;
                    positions[iz] += (tz - positions[iz]) * speed;
                }

                particles.geometry.attributes.position.needsUpdate = true;
            }

            composer.render();
        }

        // ================= MediaPipe æ‰‹åŠ¿è¯†åˆ« =================
        async function initMediaPipe() {
            const video = document.getElementById('input-video');
            const handStatus = document.getElementById('hand-status');
            const sysStatus = document.getElementById('sys-status');
            const loader = document.getElementById('loader');
            const progressBar = document.getElementById('progress');

            progressBar.style.width = '50%';

            try {
                const hands = new window.Hands({locateFile: (file) => {
                    return `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}`;
                }});

                hands.setOptions({
                    maxNumHands: 1,
                    modelComplexity: 1,
                    minDetectionConfidence: 0.5,
                    minTrackingConfidence: 0.5
                });

                hands.onResults(results => {
                    if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                        handStatus.innerText = "å·²è¿æ¥";
                        handStatus.style.color = "#0f0";
                        
                        const lm = results.multiHandLandmarks[0];
                        // è®¡ç®—æ‹‡æŒ‡(4)å’Œé£ŸæŒ‡(8)çš„è·ç¦»
                        const d = Math.sqrt(Math.pow(lm[4].x - lm[8].x, 2) + Math.pow(lm[4].y - lm[8].y, 2));
                        
                        // æ˜ å°„è·ç¦»ï¼šæåˆ(d<0.05) -> dispersion=1(ç‚¸å¼€), å¼ å¼€(d>0.15) -> dispersion=0(èšæ‹¢)
                        // æ³¨æ„ï¼šè¿™é‡Œåè½¬ä¸€ä¸‹é€»è¾‘å¯èƒ½æ›´ç¬¦åˆç›´è§‰ï¼š
                        // "å¼ å¼€åŒæ‰‹" -> æ”¾å¤§/æ‰©æ•£ï¼Ÿ 
                        // åŸéœ€æ±‚ï¼š"å¼ åˆæ§åˆ¶ç¼©æ”¾ä¸æ‰©æ•£"ã€‚é€šå¸¸ï¼šæåˆ=æŠ“å–/èšæ‹¢ï¼Œå¼ å¼€=é‡Šæ”¾/æ‰©æ•£ã€‚
                        // è¿™é‡Œè®¾å®šï¼šæåˆ = ä¿æŒå½¢çŠ¶ (dispersion 0)ï¼Œå¼ å¼€ = ç‚¸å¼€ (dispersion 1)
                        // æˆ–è€…åè¿‡æ¥ï¼šæåˆ = æç¢ (ç‚¸å¼€)ï¼Œå¼ å¼€ = è¿˜åŸã€‚
                        
                        // å½“å‰è®¾å®šï¼šè·ç¦»è¶Šå°(æ)ï¼Œvalè¶Šè¶‹å‘1(ç‚¸)ã€‚
                        let val = 1 - (d - 0.02) / 0.15;
                        handDispersion = Math.max(0, Math.min(1, val));

                        // ç®€å•çš„çŠ¶æ€æç¤º
                        if(handDispersion > 0.5) handStatus.innerText = "âœ¨ é‡Šæ”¾ç²’å­";
                        else handStatus.innerText = "âœŠ èšåˆæ¨¡å‹";

                    } else {
                        handStatus.innerText = "æœªæ£€æµ‹";
                        handStatus.style.color = "#666";
                        // æ²¡æ‰‹çš„æ—¶å€™ï¼Œè‡ªåŠ¨æ…¢æ…¢å›åˆ°èšæ‹¢çŠ¶æ€
                        handDispersion *= 0.9;
                    }
                });

                const cameraUtils = new Camera(video, {
                    onFrame: async () => { await hands.send({image: video}); },
                    width: 320, height: 240
                });
                
                progressBar.style.width = '80%';
                await cameraUtils.start();
                
                progressBar.style.width = '100%';
                sysStatus.innerText = "æ­£å¸¸è¿è¡Œ";
                setTimeout(() => loader.style.opacity = '0', 500);
                setTimeout(() => loader.style.display = 'none', 1000);

            } catch (error) {
                console.error(error);
                sysStatus.innerText = "æ‘„åƒå¤´é”™è¯¯";
                sysStatus.style.color = "red";
                alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥ï¼Œè¯·ç¡®ä¿åœ¨ HTTPS ç¯å¢ƒè¿è¡Œ");
            }
        }

        // ================= å¯åŠ¨ =================
        initUI();
        initThree();
        window.onload = initMediaPipe;

    </script>
</body>
</html>
